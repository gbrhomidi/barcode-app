<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الماسح الذكي المطور</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/241/241528.png">
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22ScanWise%22,%22short_name%22:%22Scanner%22,%22display%22:%22standalone%22,%22start_url%22:%22.%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%232196F3%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/241/241528.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]}">

    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: #f4f7f6; color: #333; }
        .app-bar { background: #2196F3; color: white; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #reader { width: 100%; max-width: 500px; margin: 10px auto; border-radius: 15px; overflow: hidden; background: #000; }
        #result-container { display: none; margin: 20px; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .national-alert { display: none; background: #4caf50; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-weight: bold; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.02);} 100% {transform: scale(1);} }
        .product-img { max-width: 180px; border-radius: 10px; margin-bottom: 15px; }
        .data-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .btn-retry { background: #2196F3; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-size: 1.1rem; margin-top: 20px; cursor: pointer; }
        .status-msg { padding: 10px; color: #666; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="app-bar">فاحص المنتجات الذكي</div>
    
    <div id="status" class="status-msg">جاري تهيئة الكاميرا...</div>
    
    <div id="reader"></div>

    <div id="result-container">
        <div id="national-badge" class="national-alert">✨ هذا المنتج صناعة اولاد الكلب و يجبمقاطعتة 100% ✨</div>
        <img id="product-img" class="product-img" src="" alt="">
        <div id="product-info"></div>
        <button class="btn-retry" onclick="restartScanner()">مسح منتج آخر</button>
    </div>

    <audio id="beep-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // --- إعدادات المستخدم ---
        const TARGET_COUNTRY = "Israel"; // يمكنك تغييرها إلى Saudi Arabia أو أي بلد آخر
        // -------------------------

        let html5QrCode;
        const beep = document.getElementById('beep-sound');

        // دالة طلب الإذن وتشغيل الكاميرا
        async function startScanner() {
            html5QrCode = new Html5Qrcode("reader");
            const statusLabel = document.getElementById('status');

            // التأكد من دعم المتصفح
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                statusLabel.innerText = "متصفحك لا يدعم الكاميرا. استخدم Chrome أو Safari.";
                return;
            }

            // محاولة التشغيل
            html5QrCode.start(
                { facingMode: "environment" }, // الكاميرا الخلفية
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess
            ).then(() => {
                statusLabel.innerText = "وجه الكاميرا نحو باركود المنتج";
            }).catch(err => {
                console.error(err);
                if (err.name === 'NotAllowedError' || err.toString().includes("Permission denied")) {
                    statusLabel.innerHTML = "<b style='color:red;'>خطأ: يجب السماح للكاميرا بالعمل من إعدادات المتصفح.</b>";
                    alert("يرجى الضغط على أيقونة القفل بجانب الرابط والسماح بالكاميرا.");
                } else {
                    statusLabel.innerText = "خطأ في الكاميرا: " + err;
                }
            });
        }

        async function onScanSuccess(decodedText) {
            // إيقاف الكاميرا فور التقاط الرمز
            await html5QrCode.stop();
            document.getElementById('status').innerText = "تم الالتقاط! جاري جلب البيانات...";
            
            try {
                // جلب البيانات من API العالمي
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${decodedText}.json`);
                const data = await response.json();

                if (data.status === 1) {
                    showProduct(data.product, decodedText);
                } else {
                    alert("المنتج غير موجود في قاعدة البيانات العالمية.");
                    restartScanner();
                }
            } catch (error) {
                alert("خطأ في الاتصال بالإنترنت.");
                restartScanner();
            }
        }

        function showProduct(product, code) {
            const container = document.getElementById('result-container');
            const badge = document.getElementById('national-badge');
            const infoDiv = document.getElementById('product-info');
            const img = document.getElementById('product-img');

            const name = product.product_name || "غير معروف";
            const brand = product.brands || "غير معروفة";
            const origin = product.countries || "غير محدد";

            img.src = product.image_url || "https://via.placeholder.com/150?text=No+Image";
            
            infoDiv.innerHTML = `
                <div class="data-row"><span>الباركود:</span> <strong>${code}</strong></div>
                <div class="data-row"><span>المنتج:</span> <strong>${name}</strong></div>
                <div class="data-row"><span>الماركة:</span> <strong>${brand}</strong></div>
                <div class="data-row"><span>المنشأ:</span> <strong>${origin}</strong></div>
            `;

            // التحقق من بلد المنشأ
            if (origin.toLowerCase().includes(TARGET_COUNTRY.toLowerCase())) {
                badge.style.display = 'block';
                beep.play(); // تشغيل صوت
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]); // اهتزاز
            } else {
                badge.style.display = 'none';
            }

            document.getElementById('reader').style.display = 'none';
            document.getElementById('status').style.display = 'none';
            container.style.display = 'block';
        }

        function restartScanner() {
            document.getElementById('result-container').style.display = 'none';
            document.getElementById('reader').style.display = 'block';
            document.getElementById('status').style.display = 'block';
            startScanner();
        }

        // بدء التطبيق
        window.onload = startScanner;
    </script>
</body>
</html>
